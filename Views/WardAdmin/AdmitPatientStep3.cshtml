@model ONT_3rdyear_Project.WardAdminViewModels.MedicalHistoryStepViewModel
@{
    ViewData["Title"] = "Admit Patient - Step 3: Medical History";
}


<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<link href="~/css/WardAdmin/AdmissionSteps.css" rel="stylesheet" asp-append-version="true">


<div class="admission-wrapper">
    <!-- Floating background elements -->
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <div class="container">
        <!-- Header Navigation -->
        <div class="admission-header">
            <div class="back-button">
                <a asp-action="AdmitPatientStep2" asp-route-patientId="@Model.PatientID" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Step 2
                </a>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-step">
                    <div class="step-number completed">1</div>
                    <span class="step-label">Basic Info</span>
                </div>
                <div class="step-connector active"></div>
                <div class="progress-step">
                    <div class="step-number completed">2</div>
                    <span class="step-label">Allergies</span>
                </div>
                <div class="step-connector active"></div>
                <div class="progress-step">
                    <div class="step-number active">3</div>
                    <span class="step-label active">Medical History</span>
                </div>
                <div class="step-connector"></div>
                <div class="progress-step">
                    <div class="step-number">4</div>
                    <span class="step-label">Summary</span>
                </div>
            </div>
        </div>

        <!-- Form Card -->
        <div class="admission-card">
            <div class="card-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <h4>
                    <i class="bi bi-journal-medical"></i>
                    Step 3: Medical History & Chronic Conditions
                </h4>
            </div>
            <div class="card-body">
                <form asp-action="AdmitPatientStep3" method="post" id="medicalHistoryForm">
                    <input type="hidden" name="PatientID" value="@Model.PatientID" />

                    <div class="medical-history-container">
                        <h5 class="form-section-title">
                            <i class="bi bi-clipboard2-pulse"></i>
                            Medical History Records
                        </h5>

                        <!-- Medical History List -->
                        <div class="history-list" id="historyList">
                            @if (Model.MedicalHistories != null && Model.MedicalHistories.Any())
                            {
                                for (int i = 0; i < Model.MedicalHistories.Count; i++)
                                {
                                    <div class="history-item" data-index="@i">
                                        <div class="history-header">
                                            <div class="history-title">
                                                <i class="bi bi-file-medical"></i>
                                                Condition @(i + 1)
                                            </div>
                                            <button type="button" class="remove-history" onclick="removeHistory(@i)">
                                                <i class="bi bi-x-circle-fill"></i>
                                            </button>
                                        </div>
                                        <div class="history-grid">
                                            <div class="history-detail">
                                                <div class="history-label">
                                                    <i class="bi bi-heart-pulse"></i>
                                                    Chronic Condition
                                                </div>
                                                <div class="history-value">@Model.MedicalHistories[i].ChronicCondition</div>
                                            </div>
                                            <div class="history-detail">
                                                <div class="history-label">
                                                    <i class="bi bi-capsule"></i>
                                                    Medication History
                                                </div>
                                                <div class="history-value">@Model.MedicalHistories[i].MedicationHistory</div>
                                            </div>
                                            <div class="history-detail">
                                                <div class="history-label">
                                                    <i class="bi bi-scissors"></i>
                                                    Surgical History
                                                </div>
                                                <div class="history-value">@Model.MedicalHistories[i].PastSurgicalHistory</div>
                                            </div>
                                            <div class="history-detail">
                                                <div class="history-label">
                                                    <i class="bi bi-activity"></i>
                                                    Severity
                                                </div>
                                                <div class="severity-badge severity-@Model.MedicalHistories[i].ConditionSeverity?.ToLower()">
                                                    @Model.MedicalHistories[i].ConditionSeverity
                                                </div>
                                            </div>
                                            <div class="history-detail">
                                                <div class="history-label">
                                                    <i class="bi bi-calendar"></i>
                                                    Recorded Date
                                                </div>
                                                <div class="history-value">@Model.MedicalHistories[i].RecorderDate.ToString("dd MMM yyyy")</div>
                                            </div>
                                        </div>
                                        <!-- Hidden fields for form submission -->
                                        <input type="hidden" asp-for="MedicalHistories[i].ChronicCondition" />
                                        <input type="hidden" asp-for="MedicalHistories[i].MedicationHistory" />
                                        <input type="hidden" asp-for="MedicalHistories[i].PastSurgicalHistory" />
                                        <input type="hidden" asp-for="MedicalHistories[i].ConditionSeverity" />
                                        <input type="hidden" asp-for="MedicalHistories[i].RecorderDate" />
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="no-history-message">
                                    <i class="bi bi-file-medical"></i>
                                    <h5>No Medical History Recorded</h5>
                                    <p>Click the button below to add the patient's first medical condition</p>
                                </div>
                            }
                        </div>

                        <!-- Add History Button -->
                        <button type="button" class="add-history-btn" onclick="showHistoryForm()">
                            <i class="bi bi-plus-circle"></i>
                            Add Medical Condition
                        </button>

                        <!-- New History Form (Initially Hidden) -->
                        <div class="history-form-container" id="historyForm" style="display: none;">
                            <h6 class="form-section-title">
                                <i class="bi bi-plus-circle"></i>
                                Add New Medical Condition
                            </h6>

                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="bi bi-heart-pulse"></i>
                                        Chronic Condition
                                    </label>
                                    <input type="text" class="form-control" id="newChronicCondition"
                                           placeholder="e.g., Hypertension, Diabetes, Asthma..." />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="bi bi-capsule"></i>
                                        Medication History
                                    </label>
                                    <input type="text" class="form-control" id="newMedicationHistory"
                                           placeholder="Current medications and dosages..." />
                                </div>

                                <div class="form-group">
                                    <label class="form-label">
                                        <i class="bi bi-scissors"></i>
                                        Past Surgical History
                                    </label>
                                    <input type="text" class="form-control" id="newSurgicalHistory"
                                           placeholder="Previous surgeries and procedures..." />
                                </div>

                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="bi bi-activity"></i>
                                        Condition Severity
                                    </label>
                                    <select class="form-select" id="newConditionSeverity">
                                        <option value="">-- Select Severity --</option>
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label required">
                                        <i class="bi bi-calendar"></i>
                                        Recorded Date
                                    </label>
                                    <input type="date" class="form-control" id="newRecordedDate" />
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="hideHistoryForm()">
                                    <i class="bi bi-x"></i>
                                    Cancel
                                </button>
                                <button type="button" class="btn btn-primary" onclick="addHistory()">
                                    <i class="bi bi-plus"></i>
                                    Add Condition
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <a asp-action="AdmitPatientStep2" asp-route-patientId="@Model.PatientID" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i>
                            Previous
                        </a>
                        <button type="submit" class="btn btn-success" id="submitBtn">
                            <i class="bi bi-check-circle"></i>
                            Complete Admission
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        let historyCount = @(Model.MedicalHistories?.Count ?? 0);

        // Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newRecordedDate').value = today;
        });

        function showHistoryForm() {
            document.getElementById('historyForm').style.display = 'block';
            document.querySelector('.add-history-btn').style.display = 'none';
            resetHistoryForm();
        }

        function hideHistoryForm() {
            document.getElementById('historyForm').style.display = 'none';
            document.querySelector('.add-history-btn').style.display = 'block';
        }

        function resetHistoryForm() {
            document.getElementById('newChronicCondition').value = '';
            document.getElementById('newMedicationHistory').value = '';
            document.getElementById('newSurgicalHistory').value = '';
            document.getElementById('newConditionSeverity').value = '';

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('newRecordedDate').value = today;
        }

        function addHistory() {
            const chronicCondition = document.getElementById('newChronicCondition');
            const severity = document.getElementById('newConditionSeverity');
            const recordedDate = document.getElementById('newRecordedDate');

            // Validation
            if (!chronicCondition.value.trim()) {
                alert('Please enter the chronic condition');
                chronicCondition.focus();
                return;
            }

            if (!severity.value) {
                alert('Please select the condition severity');
                severity.focus();
                return;
            }

            if (!recordedDate.value) {
                alert('Please select the recorded date');
                recordedDate.focus();
                return;
            }

            // Create new history item
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.dataset.index = historyCount;

            const medicationHistory = document.getElementById('newMedicationHistory').value;
            const surgicalHistory = document.getElementById('newSurgicalHistory').value;
            const recordedDateFormatted = new Date(recordedDate.value).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            historyItem.innerHTML = `
                <div class="history-header">
                    <div class="history-title">
                        <i class="bi bi-file-medical"></i>
                        Condition ${historyCount + 1}
                    </div>
                    <button type="button" class="remove-history" onclick="removeHistory(${historyCount})">
                        <i class="bi bi-x-circle-fill"></i>
                    </button>
                </div>
                <div class="history-grid">
                    <div class="history-detail">
                        <div class="history-label">
                            <i class="bi bi-heart-pulse"></i>
                            Chronic Condition
                        </div>
                        <div class="history-value">${chronicCondition.value}</div>
                    </div>
                    ${medicationHistory ? `
                    <div class="history-detail">
                        <div class="history-label">
                            <i class="bi bi-capsule"></i>
                            Medication History
                        </div>
                        <div class="history-value">${medicationHistory}</div>
                    </div>
                    ` : ''}
                    ${surgicalHistory ? `
                    <div class="history-detail">
                        <div class="history-label">
                            <i class="bi bi-scissors"></i>
                            Surgical History
                        </div>
                        <div class="history-value">${surgicalHistory}</div>
                    </div>
                    ` : ''}
                    <div class="history-detail">
                        <div class="history-label">
                            <i class="bi bi-activity"></i>
                            Severity
                        </div>
                        <div class="severity-badge severity-${severity.value.toLowerCase()}">
                            ${severity.value}
                        </div>
                    </div>
                    <div class="history-detail">
                        <div class="history-label">
                            <i class="bi bi-calendar"></i>
                            Recorded Date
                        </div>
                        <div class="history-value">${recordedDateFormatted}</div>
                    </div>
                </div>
                <input type="hidden" name="MedicalHistories[${historyCount}].ChronicCondition" value="${chronicCondition.value}" />
                <input type="hidden" name="MedicalHistories[${historyCount}].MedicationHistory" value="${medicationHistory}" />
                <input type="hidden" name="MedicalHistories[${historyCount}].PastSurgicalHistory" value="${surgicalHistory}" />
                <input type="hidden" name="MedicalHistories[${historyCount}].ConditionSeverity" value="${severity.value}" />
                <input type="hidden" name="MedicalHistories[${historyCount}].RecorderDate" value="${recordedDate.value}" />
            `;

            // Remove no history message if it exists
            const noHistoryMsg = document.querySelector('.no-history-message');
            if (noHistoryMsg) {
                noHistoryMsg.remove();
            }

            document.getElementById('historyList').appendChild(historyItem);
            historyCount++;

            // Hide form and show add button
            hideHistoryForm();
        }

        function removeHistory(index) {
            const historyItem = document.querySelector(`.history-item[data-index="${index}"]`);
            if (historyItem) {
                historyItem.remove();

                // Reindex remaining items
                const items = document.querySelectorAll('.history-item');
                if (items.length === 0) {
                    // Show no history message if all are removed
                    const historyList = document.getElementById('historyList');
                    historyList.innerHTML = `
                        <div class="no-history-message">
                            <i class="bi bi-file-medical"></i>
                            <h5>No Medical History Recorded</h5>
                            <p>Click the button below to add the patient's first medical condition</p>
                        </div>
                    `;
                }
            }
        }

        // Handle form submission
        document.getElementById('medicalHistoryForm').addEventListener('submit', function(e) {
            // Medical history is optional, so no validation needed
        });
    </script>
}
